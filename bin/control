#!/bin/bash -eu

source $OPENSHIFT_CARTRIDGE_SDK_BASH

cartridge_type="cpuminer"
version=2.4

function start() {
  echo "Starting $cartridge_type cart"

  ${OPENSHIFT_CPUMINER_DIR}bin/minerd --benchmark > ${OPENSHIFT_TMP_DIR}/${cartridge_type}.log 2>&1 &
}

function stop() {
  echo "Stopping $cartridge_type cart"

  pid=`pgrep -f "minerd" 2> /dev/null`
  echo "Sending SIGTERM to minerd:$pid ..." 1>&2
  kill -TERM $pid > /dev/null 2>&1
}

function restart() {
    echo "Restarting $cartridge_type cart"
    stop
    start
}

function status() {
    return 0
}

function reload() {
    echo "Reloading $cartridge_type cart"
    restart
}

# Clean up any log files
function tidy() {
  client_message "Emptying log dir: $OPENSHIFT_CPUMINER_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_CPUMINER_LOG_DIR/*
}

case "$1" in
  start)           start ;;
  stop)            stop ;;
  restart)         restart ;;
  status)          status ;;
  reload)          reload ;;
  tidy)            tidy ;;
  *)               exit 0
esac
