#!/bin/bash -eu

source $OPENSHIFT_CARTRIDGE_SDK_BASH

CPUMINER_BIN_DIR=${OPENSHIFT_CPUMINER_DIR}bin

cartridge_type="cpuminer"
version=2.4


# Check if the wildfly process is running
function isrunning() {

    # Check for running app
	pid=$(ps -ef | grep "minerd" | awk '{print $2}')
	if [ "$pid" != "" ]; then
		return 0
	else
		return 1
	fi
}

function start() {
  echo "Starting $cartridge_type cart"

  #Check for running app
  if isrunning; then
      echo "Application is already running"
  else
      pushd ${OPENSHIFT_CPUMINER_DIR}/minerd
      bin minerd --help
      popd
	  #cd $OPENSHIFT_REPO_DIR
	  #echo "Executing bundle install"
	  #echo "Starting MINERD server"

      #if ! ishttpup; then
      #    echo "Timed out waiting for http listening port"
      #    exit 1
      #fi
	  #exit 0
  fi
}

function build() {
    echo "Building CpuMiner"
}

function deploy() {
    echo "building CpuMiner"
}

function stop() {
  echo "Stopping $cartridge_type cart"

  if isrunning; then
      pid=$(ps -ef | grep "minerd" | awk '{print $2}')
      echo "Sending SIGTERM to minerd:$pid ..." 1>&2
      kill $pid
  fi
}

function restart() {
    echo "Restarting $cartridge_type cart"

    stop

    start
}

function status() {
   if isrunning
   then
      client_result "Application is running"
   else
      client_result "Application is either stopped or inaccessible"
   fi
}

function reload() {
    echo "Reloading $cartridge_type cart"
    restart
}

# Clean up any log files
function tidy() {
  client_message "Emptying log dir: $OPENSHIFT_MINERD_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_MINERD_LOG_DIR/*
}

case "$1" in
  build)           build ;;
  deploy)          deploy ;;
  start)           start ;;
  stop)            stop ;;
  restart)         restart ;;
  status)          status ;;
  reload)          reload ;;
  tidy)            tidy ;;
  *)               exit 0
esac

