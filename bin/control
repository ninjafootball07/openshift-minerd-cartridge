#!/bin/bash -eu

source $OPENSHIFT_CARTRIDGE_SDK_BASH

cartridge_type="cpuminer"
version=2.4

function start() {
  echo "Starting $cartridge_type cart"

  CPUMINER_CMD="${OPENSHIFT_CPUMINER_DIR}bin/minerd"

  if [ -f "${OPENSHIFT_REPO_DIR}/.openshift/markers/cpuminer_config" ]; then
    CPUMINER_CMD="${CPUMINER_CMD}  --config ${OPENSHIFT_DATA_DIR}.minerdrc"
  else

    if [ -n "$CPUMINER_USER" ]; then
      CPUMINER_CMD="${CPUMINER_CMD} --user=${CPUMINER_USER}"
    fi

    if [ -n "$CPUMINER_PASS" ]; then
      CPUMINER_CMD="${CPUMINER_CMD} --pass=${CPUMINER_PASS}"
    fi

    if [ -n "$CPUMINER_URL" ]; then
      CPUMINER_CMD="${CPUMINER_CMD} --url=${CPUMINER_URL}"
    fi
  fi

  $CPUMINER_CMD >> ${OPENSHIFT_CPUMINER_LOG_DIR}minerd.log 2>&1 &
}

function stop() {
  echo "Stopping $cartridge_type cart"

  pid=`pgrep -f "minerd" 2> /dev/null`
  echo "Sending SIGTERM to minerd:$pid ..." 1>&2
  kill -TERM $pid > /dev/null 2>&1
}

function restart() {
    echo "Restarting $cartridge_type cart"
    stop
    start
}

function status() {
    return 0
}

function reload() {
    echo "Reloading $cartridge_type cart"
    restart
}

# Clean up any log files
function tidy() {
  client_message "Emptying log dir: $OPENSHIFT_CPUMINER_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_CPUMINER_LOG_DIR/*
}

case "$1" in
  start)           start ;;
  stop)            stop ;;
  restart)         restart ;;
  status)          status ;;
  reload)          reload ;;
  tidy)            tidy ;;
  *)               exit 0
esac
